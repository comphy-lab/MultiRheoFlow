<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
  <!-- 
    IMPORTANT: DO NOT place empty anchor tags <a></a> in this template!
    They cause JavaScript syntax errors when they appear inside script blocks.
  -->
  <!-- Eliminate FOUC (Flash of Unstyled Content) and FOUT (Flash of Incorrect Theme) -->
  <script>
    (function() {
  try {
    // Apply the theme as quickly as possible to avoid flash
    let saved;
    try {
      saved = localStorage.getItem('theme');
    } catch (storageError) {
      // Handle localStorage access errors (private browsing, cookies disabled)
      console.warn('Unable to access localStorage:', storageError);
    }

    let prefersDark = false;
    try {
      prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    } catch (mediaError) {
      // Handle matchMedia access errors (unsupported browsers)
      console.warn('Unable to check media query:', mediaError);
    }

    const theme = saved ? saved : (prefersDark ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', theme);
    // Add theme class for CSS targeting
    document.documentElement.classList.add(theme + '-theme');
    // Mark when theme is set for CSS transitions
    document.documentElement.classList.add('theme-set');
  } catch (error) {
    // Fallback for any other unexpected errors
    console.warn('Theme initialization failed:', error);
    // Apply default theme as fallback
    try {
      document.documentElement.setAttribute('data-theme', 'light');
      document.documentElement.classList.add('light-theme');
      document.documentElement.classList.add('theme-set');
    } catch (fallbackError) {
      // Silent catch for extreme cases
      console.error('Critical theme fallback failed:', fallbackError);
    }
  }
})();
  </script>


  <!-- No-JS fallback for theme and critical theming styles -->
  <style>
    /* Default light theme variables */
    :root {
      /* Base colors */
      --color-background: #fff;
      --color-text: #333;
      --color-primary: #0066cc;
      --color-secondary: #036;
      --color-accent: #0099ff;

      /* UI elements */
      --color-header-bg: #f5f5f5;
      --color-footer-bg: #2d2e33;
      --color-border: #e0e0e0;
      --color-input-bg: #f9f9f9;

      /* Component colors */
      --color-preloader-bg: #ffffff;
      --color-loader: #0066cc;
      --color-card-bg: #ffffff;
      --color-code-bg: #f5f5f5;
    }

    /* Dark theme variables applied via media query when JS is disabled */
    @media (prefers-color-scheme: dark) {
      :root:not(.theme-set) {
        /* Base colors - dark mode */
        --color-background: #1a1a1a;
        --color-text: #f5f5f5;
        --color-primary: #4d9fff;
        --color-secondary: #88ccff;
        --color-accent: #00bfff;

        /* UI elements - dark mode */
        --color-header-bg: #121212;
        --color-footer-bg: #121212;
        --color-border: #333;
        --color-input-bg: #2d2d2d;

        /* Component colors - dark mode */
        --color-preloader-bg: #1a1a1a;
        --color-loader: #4d9fff;
        --color-card-bg: #222;
        --color-code-bg: #2d2d2d;
      }
    }

    /* When JS sets the theme explicitly via data attribute */
    [data-theme="dark"] {
      /* Base colors - dark mode */
      --color-background: #1a1a1a;
      --color-text: #f5f5f5;
      --color-primary: #4d9fff;
      --color-secondary: #88ccff;
      --color-accent: #00bfff;

      /* UI elements - dark mode */
      --color-header-bg: #121212;
      --color-footer-bg: #121212;
      --color-border: #333;
      --color-input-bg: #2d2d2d;

      /* Component colors - dark mode */
      --color-preloader-bg: #1a1a1a;
      --color-loader: #4d9fff;
      --color-card-bg: #222;
      --color-code-bg: #2d2d2d;
    }

    /* Prevent transition flashes during initial load */
    html:not(.transitions-enabled) * {
      transition: none !important;
    }

    /* Apply theme to preloader and early elements */
    #preloader {
      background-color: var(--color-preloader-bg);
      color: var(--color-text);
    }

    #loader {
      border-color: var(--color-loader);
      border-top-color: transparent;
    }

    /* Noscript warning */
    .noscript-warning {
      background-color: var(--color-primary);
      color: white;
      text-align: center;
      padding: 10px;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    /* Theme indicator for no-JS */
    .theme-indicator {
      padding: 5px 10px;
      border-radius: 4px;
      background-color: var(--color-input-bg);
      color: var(--color-text);
      text-align: center;
    }

    /* Hide JS-only elements when no JS */
    .no-js .js-only {
      display: none !important;
    }

    /* Show no-JS alternatives */
    .js .no-js-only {
      display: none !important;
    }
  </style>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="base-url" content="..">
  <title>src-local/log-conform-elastoviscoplastic-HB-scalar-2D.h | MultiRheoFlow</title>

  <!-- Critical CSS for fastest paint -->
  <style>
      .s-intro__title {
          visibility: visible;
          font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }
      .s-header {
          visibility: visible;
      }

      /* Ensure theme toggle properly styled immediately */
      .theme-toggle {
          background-color: var(--color-background);
          color: var(--color-text);
      }

      /* Control SVG visibility based on theme */
      [data-theme="dark"] .theme-toggle-icon.sun,
      :root:not([data-theme="dark"]) .theme-toggle-icon.moon {
          display: block;
      }

      [data-theme="dark"] .theme-toggle-icon.moon,
      :root:not([data-theme="dark"]) .theme-toggle-icon.sun {
          display: none;
      }
  </style>

  <!-- Critical Meta Tags -->
  <meta name="description" content="Scalar log-conformation implementation for 2D and axisymmetric elasto-viscoplastic Herschel-Bulkley flows.">
  <meta name="author" content="CoMPhy Lab">
  <meta name="robots" content="index, follow">
  <meta name="keywords" content="bcg.h, conform, elastoviscoplastic, scalar, struct">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-title" content="CoMPhy Lab">

  <!-- Preload critical resources -->
  <link rel="preload" href="../assets/js/main.js" as="script">
  <link rel="preload" href="../assets/css/fontello/css/fontello.css" as="style">
  <link rel="preload" href="../assets/css/academicons-1.7.0/css/academicons.min.css" as="style">

  <!-- Base stylesheets -->
  <link rel="stylesheet" href="../assets/css/styles.css">
  <link rel="stylesheet" href="../assets/css/custom_styles.css">
  <link rel="stylesheet" href="../assets/css/command-palette.css">
  <link rel="stylesheet" href="../assets/css/fontello/css/fontello.css">
  <link rel="stylesheet" href="../assets/css/academicons-1.7.0/css/academicons.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

  <!-- Font optimization -->
  <style>
      @font-face {
          font-display: swap;
          font-family: 'System Font';
          src: local('system-ui');
      }
  </style>

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="../assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="96x96" href="../assets/favicon/favicon-96x96.png">
  <link rel="icon" type="image/svg+xml" href="../assets/favicon/favicon.svg">
  <link rel="shortcut icon" href="../assets/favicon/favicon.ico">
  <link rel="manifest" href="../assets/favicon/site.webmanifest">

  <!-- Scripts with proper loading attributes -->
  <script>
    window.ASSET_PATH_PREFIX = "..";
  </script>
  <script src="../assets/js/jquery.min.js"></script>
  <script src="../assets/js/jquery-ui.packed.js"></script>
  <script src="../assets/js/plots.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
  <!-- Config script must load before other scripts -->
  <script src="../assets/js/config.js"></script>
  <script defer src="../assets/js/html-sanitizer.js"></script>
  <script defer src="../assets/js/search-helper.js"></script>
  <script defer src="../assets/js/command-palette.js"></script>
  <script defer src="../assets/js/command-data.js"></script>
  <script defer src="../assets/js/main.js"></script>
  <script defer src="../assets/js/theme-toggle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script"></script>

  <!-- Optimize page load performance -->
  <script>
    // Preconnect to critical domains
    const preconnectDomains = [
      'https://cdnjs.cloudflare.com',
      'https://cdn.jsdelivr.net'
    ];

    preconnectDomains.forEach(domain => {
      const link = document.createElement('link');
      link.rel = 'preconnect';
      link.href = domain;
      link.crossOrigin = 'anonymous';
      document.head.appendChild(link);

      // Also add DNS prefetch as fallback
      const dnsLink = document.createElement('link');
      dnsLink.rel = 'dns-prefetch';
      dnsLink.href = domain;
      document.head.appendChild(dnsLink);
    });

    // Detect when document is fully loaded to remove preloader
    window.addEventListener('load', function() {
      const preloader = document.getElementById('preloader');
      if (preloader) {
        preloader.style.opacity = '0';
        setTimeout(() => {
          preloader.style.display = 'none';
        }, 300); // Match transition duration
      }
    });
  </script>

  <script>
      // Load Font Awesome with proper environment detection and fallbacks
      function loadStylesheet(href) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = href;
        link.crossOrigin = 'anonymous';
        link.onerror = (e) => {
          console.error(`Failed to load stylesheet: `, e);
          console.log('Trying alternative Font Awesome source...');
        };
        document.head.appendChild(link);
        return link;
      }

      // Check if we're on localhost
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        // Use hardcoded version numbers for reliable loading

        // Load Font Awesome using multiple CDNs to maximize reliability for local development
        loadStylesheet('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css');
        // Backup CDN if the first one fails
        loadStylesheet('https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css');
        // Final local fallback - ensures it will work on any localhost environment
        loadStylesheet('https://use.fontawesome.com/releases/v6.7.2/css/all.css');
      } else {
        // Use Kit for production with defer
        var script = document.createElement('script');
        script.src = 'https://kit.fontawesome.com/b1cfd9ca75.js';
        script.crossOrigin = 'anonymous';
        script.defer = true;
        document.head.appendChild(script);
      }
    </script>

  <script>
      // Mark page as JS-enabled and manage transitions
      document.documentElement.classList.remove('no-js');
      document.documentElement.classList.add('js');

      // Allow CSS transitions after initial load to prevent transition flashes
      window.addEventListener('DOMContentLoaded', () => {
          setTimeout(() => {
              document.documentElement.classList.add('transitions-enabled');
          }, 100); // Short delay to ensure DOM is ready
      });
  </script>
</head>
<body id="top">
<script>
window.repoName = "MultiRheoFlow";
window.githubOrg = "comphy-lab";
window.baseDomain = "https://comphy-lab.org/MultiRheoFlow";
</script>


    <!-- Preloader with theme variables applied -->
    <div id="preloader">
        <div id="loader"></div>
    </div>

    <noscript>
        <div class="noscript-warning">
            <p>This site works best with JavaScript enabled. Some features may be limited.</p>
        </div>
    </noscript>

    <div id="page" class="s-pagewrap">
        <header class="s-header">
            <div class="s-header__logo">
                <a class="logo" href="/">
                    <img src="../assets/logos/CoMPhy-Lab-no-name.png" alt="CoMPhy Lab">
                </a>
                <a class="documentation-button" href="/MultiRheoFlow">
                    <i class="fa-solid fa-book-open"></i>
                    <span>MultiRheoFlow</span>
                </a>
            </div>
            <a class="s-header__menu-toggle" href="#0">
                <span class="s-header__menu-text">Menu</span>
                <span class="s-header__menu-icon"></span>
            </a>
            <nav class="s-header__nav">
                <a href="#0" class="s-header__nav-close-btn"><span>Close</span></a>
                <ul class="s-header__nav-list">
                    <li style="background: none;">
                        <!-- JS theme toggle -->
                        <div class="theme-toggle js-only" id="theme-toggle" aria-label="Toggle dark/light theme">
                            <svg class="theme-toggle-icon moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                            </svg>
                            <svg class="theme-toggle-icon sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="5"></circle>
                                <line x1="12" y1="1" x2="12" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="23"></line>
                                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                <line x1="1" y1="12" x2="3" y2="12"></line>
                                <line x1="21" y1="12" x2="23" y2="12"></line>
                                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                            </svg>
                        </div>
                    </li>
                    <!-- NOTE: The following links are organization-specific. Customize for your organization. -->
                    <li style="background: none;"><a href="https://scholar.google.com/citations?user=tHb_qZoAAAAJ&hl=en" style="background: none; padding: 0;" aria-label="Google Scholar Profile"><i class="ai ai-google-scholar" style="font-size: 1.75em;"></i></a></li>
                    <li style="background: none;"><a href="https://github.com/comphy-lab" style="background: none; padding: 0;" aria-label="GitHub Organization"><i class="fa-brands fa-github" style="font-size: 1.75em"></i></a></li>
                    <li><a href="https://comphy-lab.org/#about" class="smoothscroll">About</a></li>
                    <li><a href="https://comphy-lab.org/team/">Team</a></li>
                    <li><a href="https://comphy-lab.org/research">Research</a></li>
                    <li><a href="https://comphy-lab.org/teaching">Teaching</a></li>
                    <li><a href="https://comphy-lab.org/join">Join Us</a></li>
                    <li><a href="https://blogs.comphy-lab.org/">Blog</a></li>
                    <li style="background: none;"><a href="https://bsky.app/profile/comphy-lab.org" style="background: none; padding: 0;" aria-label="Bluesky Profile"><i class="fa-brands fa-bluesky" style="font-size: 1.75em; color: #0085ff;"></i></a></li>
                    <!-- Command Palette Button (Styled like search) -->
                    <li class="command-palette-button">
                        <div class="command-wrapper">
                            <button class="command-k-style-btn" id="command-palette-btn" aria-label="Open command palette">
                                <span class="default-theme-text">ctrl K</span>
                                <span class="mac-theme-text">⌘ K</span>
                                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                            </button>
                        </div>
                    </li>
                </ul>
            </nav>
        </header>

        <!-- Main content -->
        <main class="content">

            <div class="page-content">

                                <h1 class="page-title">src-local/log-conform-elastoviscoplastic-HB-scalar-2D.h</h1>


                                <div class="raw-file-button-container">
                    <a href="https://github.com/comphy-lab/MultiRheoFlow/raw/main/src-local/log-conform-elastoviscoplastic-HB-scalar-2D.h" class="raw-file-button" target="_blank" rel="noopener noreferrer">
                        <i class="fa-brands fa-github"></i> See raw file
                    </a>
                </div>

                <h1
                id="log-conformation-scalar-2daxi-evp-hb">Log-Conformation
                (Scalar 2D/Axi EVP-HB)</h1>
                <p>Scalar log-conformation implementation for 2D and
                axisymmetric elasto-viscoplastic Herschel-Bulkley
                flows.</p>
                <h2 id="key-features">Key Features</h2>
                <ul>
                <li>Conformation tensor components stored as
                scalars.</li>
                <li>Supports 2D and axisymmetric configurations.</li>
                <li>Mirrors
                <code>log-conform-elastoviscoplastic-HB-scalar-3D.h</code>.</li>
                </ul>
                <h2 id="change-log">Change Log</h2>
                <ul>
                <li>2024-10-18: Initial 2D/axi implementation.</li>
                <li>2024-11-03: Axisymmetric mirror of 3D scalar
                version.</li>
                <li>2024-11-14: Infinite Deborah support.</li>
                <li>2024-11-23: Documentation updates.</li>
                <li>2026-02-02: Unify MultiRheoFlow docs across all
                submodules.</li>
                <li>2026-02-09: Add HB variant with <code>nHB</code> and
                HB relaxation factor.</li>
                </ul>
                <h2 id="future-work">Future Work</h2>
                <ul>
                <li>Convert to tensor formulation for consistency and
                maintainability.</li>
                <li>Track: comphy-lab/Viscoelastic3D#11, #5.</li>
                </ul>
                <h2 id="author">Author</h2>
                <p>Vatsal Sanjay, Arivazhagan G. Balasubramanian Email:
                vatsal.sanjay@comphy-lab.org Last updated:
                2025-06-30</p>
                <h1
                id="the-log-conformation-method-for-evp-hb-constitutive-models">The
                log-conformation method for EVP-HB constitutive
                models</h1>
                <h2 id="introduction">Introduction</h2>
                <p>Elasto-viscoplastic fluids exhibit viscous, elastic
                and plastic behaviour when subjected to deformation.
                Therefore these materials are governed by the
                Navier–Stokes equations enriched with an extra stress
                <span class="math inline">\(Tij\)</span> <span
                class="math display">\[
                \rho\left[\partial_t\mathbf{u}+\nabla\cdot(\mathbf{u}\otimes\mathbf{u})\right]
                =
                - \nabla p + \nabla\cdot(2\mu_s\mathbf{D}) +
                \nabla\cdot\mathbf{T}
                + \rho\mathbf{a}
                \]</span> where <span
                class="math inline">\(\mathbf{D}=[\nabla\mathbf{u} +
                (\nabla\mathbf{u})^T]/2\)</span> is the deformation
                tensor and <span class="math inline">\(\mu_s\)</span> is
                the solvent viscosity of the EVP fluid.</p>
                <p>The extra stress <span
                class="math inline">\(\mathbf{T}\)</span> includes
                memory effects due to the polymers and the plasticity
                effects associated with internal structural changes in
                the material that constitutes to yielding the material
                and fluidizes it. Several constitutive rheological
                models are available in the literature where the extra
                stress <span class="math inline">\(\mathbf{T}\)</span>
                is typically a function <span
                class="math inline">\(\mathbf{f_s}(\cdot)\)</span> of
                the conformation tensor <span
                class="math inline">\(\mathbf{A}\)</span> such as <span
                class="math display">\[
                \mathbf{T} = G_p \mathbf{f_s}(\mathbf{A})
                \]</span> where <span class="math inline">\(G_p\)</span>
                is the elastic modulus and <span
                class="math inline">\(\mathbf{f_s}(\cdot)\)</span> is
                the relaxation function.</p>
                <p>The conformation tensor <span
                class="math inline">\(\mathbf{A}\)</span> is related to
                the deformation of the elasto-viscoplastic matrix. <span
                class="math inline">\(\mathbf{A}\)</span> is governed by
                the equation <span class="math display">\[
                D_t \mathbf{A} - \mathbf{A} \cdot \nabla \mathbf{u} -
                \nabla
                \mathbf{u}^{T} \cdot \mathbf{A} =
                -\frac{\mathbf{f_r}(\mathbf{A})}{\lambda}
                \]</span> where <span class="math inline">\(D_t\)</span>
                denotes the material derivative and <span
                class="math inline">\(\mathbf{f_r}(\cdot)\)</span> is
                the relaxation function. Here, <span
                class="math inline">\(\lambda\)</span> is the relaxation
                time.</p>
                <p>In the case of elasto-viscoplastic Herschel-Bulkley
                (HB) model, where the material before yielding is
                represented by Kelvin-Voigt viscoelastic solid and long
                after yielding recovers the Oldroyd-B type viscoelastic
                fluid behaviour, <span
                class="math inline">\(\mathbf{f}_s (\mathbf{A}) =
                \mathbf{A} -\mathbf{I}\)</span>, <span
                class="math inline">\(\mathbf{f}_r (\mathbf{A}) =
                K_{HB}(\mathbf{A} -\mathbf{I})\)</span>, and the above
                equations can be combined to avoid the use of <span
                class="math inline">\(\mathbf{A}\)</span> <span
                class="math display">\[
                (K_{HB}/\lambda) \mathbf{T} + (D_t \mathbf{T} -
                \mathbf{T} \cdot \nabla \mathbf{u} -
                \nabla \mathbf{u}^{T} \cdot \mathbf{T})  = 2 G_p\lambda
                \mathbf{D}
                \]</span></p>
                <p>Here, <span class="math display">\[
                K_{HB} = max\left[0,
                \left(\frac{\|\tau_d\|-\tau_y}
                {(G_p\lambda)^{1-n_{HB}}
                \|\tau_d\|}\right)^{1/n_{HB}}\right]
                \]</span> where <span
                class="math inline">\(n_{HB}=1\)</span> recovers the
                Saramito yield factor. The stress closure is <span
                class="math display">\[
                \mathbf{\tau}_p =
                \frac{Oh_p}{De}(\mathbf{A}-\mathbf{I}),
                \quad Oh_p = G_p\lambda
                \]</span> which is implemented as <span
                class="math inline">\(\mathbf{T} =
                G_p(\mathbf{A}-\mathbf{I})\)</span>. <a
                href="#comminal2015">Comminal et al. (2015)</a> gathered
                the functions <span class="math inline">\(\mathbf{f}_s
                (\mathbf{A})\)</span> and <span
                class="math inline">\(\mathbf{f}_r (\mathbf{A})\)</span>
                for different viscoelastic constitutive models. This
                work is an extension of such formulation for
                elasto-viscoplastic materials.</p>
                <h2 id="parameters">Parameters</h2>
                <p>The primary parameters are the relaxation time <span
                class="math inline">\(\lambda\)</span>, elastic modulus
                <span class="math inline">\(G_p\)</span>, yield stress
                <span class="math inline">\(\tau_y\)</span> and HB
                exponent <span class="math inline">\(n_{HB}\)</span>.
                The solvent viscosity <span
                class="math inline">\(\mu_s\)</span> is defined in the
                <a href="navier-stokes/centered.h">Navier-Stokes
                solver</a>.</p>
                <p>Gp, lambda, tau_y and nHB are defined in <a
                href="two-phaseEVP-HB.h">two-phaseEVP-HB.h</a>.</p>
                <h2 id="the-log-conformation-approach">The log
                conformation approach</h2>
                <p>The numerical resolution of viscoelastic and EVP
                fluid problems often faces the <a
                href="http://www.ma.huji.ac.il/~razk/iWeb/My_Site/Research_files/Visco1.pdf">High-Weissenberg
                Number Problem</a>. This is a numerical instability
                appearing when strongly elastic flows create regions of
                high stress and fine features. This instability poses
                practical limits to the values of the relaxation time of
                the viscoelastic and EVP fluid, <span
                class="math inline">\(\lambda\)</span>. <a
                href="#fattal2004">Fattal &amp; Kupferman (2004,
                2005)</a> identified the exponential nature of the
                solution as the origin of the instability. They proposed
                to use the logarithm of the conformation tensor <span
                class="math inline">\(\Psi = \log \, \mathbf{A}\)</span>
                rather than the extra stress tensor to circumvent the
                instability.</p>
                <p>The constitutive equation for the log of the
                conformation tensor is <span class="math display">\[
                D_t \Psi = (\Omega \cdot \Psi -\Psi \cdot \Omega) + 2
                \mathbf{B} +
                \frac{e^{-\Psi} \mathbf{f}_r (e^{\Psi})}{\lambda}
                \]</span> where <span
                class="math inline">\(\Omega\)</span> and <span
                class="math inline">\(\mathbf{B}\)</span> are tensors
                that result from the decomposition of the transpose of
                the tensor gradient of the velocity <span
                class="math display">\[
                (\nabla \mathbf{u})^T = \Omega + \mathbf{B} + N
                \mathbf{A}^{-1}
                \]</span></p>
                <p>The antisymmetric tensor <span
                class="math inline">\(\Omega\)</span> requires only the
                memory of a scalar in 2D since, <span
                class="math display">\[
                \Omega = \left(
                \begin{array}{cc}
                0 &amp; \Omega_{12} \\
                -\Omega_{12} &amp; 0
                \end{array}
                \right)
                \]</span></p>
                <p>For 3D, <span class="math inline">\(\Omega\)</span>
                is a skew-symmetric tensor given by</p>
                <p><span class="math display">\[
                \Omega = \left(
                \begin{array}{ccc}
                0 &amp; \Omega_{12} &amp; \Omega_{13} \\
                -\Omega_{12} &amp; 0 &amp; \Omega_{23} \\
                -\Omega_{13} &amp; -\Omega_{23} &amp; 0
                \end{array}
                \right)
                \]</span></p>
                <p>The log-conformation tensor, <span
                class="math inline">\(\Psi\)</span>, is related to the
                polymeric stress tensor <span
                class="math inline">\(\mathbf{T}\)</span>, by the strain
                function <span class="math inline">\(\mathbf{f}_s
                (\mathbf{A})\)</span> <span class="math display">\[
                \Psi = \log \, \mathbf{A} \quad \mathrm{and} \quad
                \mathbf{T} =
                \frac{G_p}{\lambda} \mathbf{f}_s (\mathbf{A})
                \]</span> where <span class="math inline">\(Tr\)</span>
                denotes the trace of the tensor and <span
                class="math inline">\(L\)</span> is an additional
                property of the viscoelastic fluid.</p>
                <p>We will use the Bell–Collela–Glaz scheme to advect
                the log-conformation tensor <span
                class="math inline">\(\Psi\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="al">TODO</span><span class="co">:</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">- Perhaps, instead of the Bell--Collela--Glaz scheme, we can use the conservative form of the advection equation and transport the log-conformation tensor with the VoF color function, similar to [http://basilisk.fr/src/navier-stokes/conserving.h](http://basilisk.fr/src/navier-stokes/conserving.h)</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><a href="https://basilisk.fr/src/bcg.h" title="Link to Basilisk source for bcg.h"><span class="im">"bcg.h"</span></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dt">const</span><span class="op">)</span> scalar Gp <span class="op">=</span> unity<span class="op">;</span> <span class="co">// elastic modulus</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dt">const</span><span class="op">)</span> scalar lambda <span class="op">=</span> unity<span class="op">;</span> <span class="co">// relaxation time</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dt">const</span><span class="op">)</span> scalar tau0 <span class="op">=</span> unity<span class="op">;</span> <span class="co">// yield-stress</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">(</span><span class="dt">const</span><span class="op">)</span> scalar nHB <span class="op">=</span> unity<span class="op">;</span> <span class="co">// HB power-law exponent</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> saramitoHB_yield_eps <span class="op">=</span> <span class="fl">1e-6</span><span class="op">;</span> <span class="co">// regularization for HB denominator</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>scalar A11<span class="op">[],</span> A12<span class="op">[],</span> A22<span class="op">[];</span> <span class="co">// conformation tensor</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>scalar T11<span class="op">[],</span> T12<span class="op">[],</span> T22<span class="op">[];</span> <span class="co">// stress tensor</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#if AXI</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>scalar AThTh<span class="op">[],</span> T_ThTh<span class="op">[];</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>event defaults <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>is_constant <span class="op">(</span>a<span class="op">.</span>x<span class="op">))</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> new face vector<span class="op">;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">/*</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">  initialize A and T</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co">  */</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>scalar s in <span class="op">{</span>A11<span class="op">,</span> A22<span class="op">})</span> <span class="op">{</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    foreach <span class="op">()</span> <span class="op">{</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>      s<span class="op">[]</span> <span class="op">=</span> <span class="fl">1.</span><span class="op">;</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>scalar s in <span class="op">{</span>T11<span class="op">,</span> T12<span class="op">,</span> T22<span class="op">,</span> A12<span class="op">})</span> <span class="op">{</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    foreach<span class="op">(){</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>      s<span class="op">[]</span> <span class="op">=</span> <span class="fl">0.</span><span class="op">;</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="pp">#if AXI</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  foreach<span class="op">(){</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    T_ThTh<span class="op">[]</span> <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    AThTh<span class="op">[]</span> <span class="op">=</span> <span class="fl">1.</span><span class="op">;</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>scalar s in <span class="op">{</span>T11<span class="op">,</span> T12<span class="op">,</span> T22<span class="op">})</span> <span class="op">{</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>s<span class="op">.</span>boundary<span class="op">[</span>left<span class="op">]</span> <span class="op">!=</span> periodic_bc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        s<span class="op">[</span>left<span class="op">]</span> <span class="op">=</span> neumann<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>          s<span class="op">[</span>right<span class="op">]</span> <span class="op">=</span> neumann<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span>scalar s in <span class="op">{</span>A11<span class="op">,</span> A12<span class="op">,</span> A22<span class="op">})</span> <span class="op">{</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>s<span class="op">.</span>boundary<span class="op">[</span>left<span class="op">]</span> <span class="op">!=</span> periodic_bc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>        s<span class="op">[</span>left<span class="op">]</span> <span class="op">=</span> neumann<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>          s<span class="op">[</span>right<span class="op">]</span> <span class="op">=</span> neumann<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="pp">#if AXI</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  T12<span class="op">[</span>bottom<span class="op">]</span> <span class="op">=</span> dirichlet <span class="op">(</span><span class="fl">0.</span><span class="op">);</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  A12<span class="op">[</span>bottom<span class="op">]</span> <span class="op">=</span> dirichlet <span class="op">(</span><span class="fl">0.</span><span class="op">);</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></div>
                <h2 id="useful-functions-in-2d">Useful functions in
                2D</h2>
                <p>The first step is to implement a routine to calculate
                the eigenvalues and eigenvectors of the conformation
                tensor <span
                class="math inline">\(\mathbf{A}\)</span>.</p>
                <p>These structs ressemble Basilisk vectors and tensors
                but are just arrays not related to the grid.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span> <span class="dt">double</span> x<span class="op">,</span> y<span class="op">;}</span>   pseudo_v<span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> <span class="op">{</span> pseudo_v x<span class="op">,</span> y<span class="op">;}</span> pseudo_t<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to initialize pseudo_v</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> init_pseudo_v<span class="op">(</span>pseudo_v <span class="op">*</span>v<span class="op">,</span> <span class="dt">double</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    v<span class="op">-&gt;</span>x <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    v<span class="op">-&gt;</span>y <span class="op">=</span> value<span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to initialize pseudo_t</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> init_pseudo_t<span class="op">(</span>pseudo_t <span class="op">*</span>t<span class="op">,</span> <span class="dt">double</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    init_pseudo_v<span class="op">(&amp;</span>t<span class="op">-&gt;</span>x<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    init_pseudo_v<span class="op">(&amp;</span>t<span class="op">-&gt;</span>y<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> diagonalization_2D <span class="op">(</span>pseudo_v <span class="op">*</span> Lambda<span class="op">,</span> pseudo_t <span class="op">*</span> R<span class="op">,</span> pseudo_t <span class="op">*</span> A<span class="op">)</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span></code></pre></div></div>
                <p>The eigenvalues are saved in vector <span
                class="math inline">\(\Lambda\)</span> computed from the
                trace and the determinant of the symmetric conformation
                tensor <span
                class="math inline">\(\mathbf{A}\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>sq<span class="op">(</span>A<span class="op">-&gt;</span>x<span class="op">.</span>y<span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1e-15</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    R<span class="op">-&gt;</span>x<span class="op">.</span>x <span class="op">=</span> R<span class="op">-&gt;</span>y<span class="op">.</span>y <span class="op">=</span> <span class="fl">1.</span><span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    R<span class="op">-&gt;</span>y<span class="op">.</span>x <span class="op">=</span> R<span class="op">-&gt;</span>x<span class="op">.</span>y <span class="op">=</span> <span class="fl">0.</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    Lambda<span class="op">-&gt;</span>x <span class="op">=</span> A<span class="op">-&gt;</span>x<span class="op">.</span>x<span class="op">;</span> Lambda<span class="op">-&gt;</span>y <span class="op">=</span> A<span class="op">-&gt;</span>y<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> T <span class="op">=</span> A<span class="op">-&gt;</span>x<span class="op">.</span>x <span class="op">+</span> A<span class="op">-&gt;</span>y<span class="op">.</span>y<span class="op">;</span> <span class="co">// Trace of the tensor</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> D <span class="op">=</span> A<span class="op">-&gt;</span>x<span class="op">.</span>x<span class="op">*</span>A<span class="op">-&gt;</span>y<span class="op">.</span>y <span class="op">-</span> sq<span class="op">(</span>A<span class="op">-&gt;</span>x<span class="op">.</span>y<span class="op">);</span> <span class="co">// Determinant</span></span></code></pre></div></div>
                <p>The eigenvectors, <span
                class="math inline">\(\mathbf{v}_i\)</span> are saved by
                columns in tensor <span class="math inline">\(\mathbf{R}
                = (\mathbf{v}_1|\mathbf{v}_2)\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>  R<span class="op">-&gt;</span>x<span class="op">.</span>x <span class="op">=</span> R<span class="op">-&gt;</span>x<span class="op">.</span>y <span class="op">=</span> A<span class="op">-&gt;</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  R<span class="op">-&gt;</span>y<span class="op">.</span>x <span class="op">=</span> R<span class="op">-&gt;</span>y<span class="op">.</span>y <span class="op">=</span> <span class="op">-</span>A<span class="op">-&gt;</span>x<span class="op">.</span>x<span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> s <span class="op">=</span> <span class="fl">1.</span><span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> dimension<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> <span class="op">*</span> ev <span class="op">=</span> <span class="op">(</span><span class="dt">double</span> <span class="op">*)</span> Lambda<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    ev<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> T<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> s<span class="op">*</span>sqrt<span class="op">(</span>sq<span class="op">(</span>T<span class="op">)/</span><span class="fl">4.</span> <span class="op">-</span> D<span class="op">);</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    s <span class="op">*=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> <span class="op">*</span> Rx <span class="op">=</span> <span class="op">(</span><span class="dt">double</span> <span class="op">*)</span> <span class="op">&amp;</span>R<span class="op">-&gt;</span>x<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> <span class="op">*</span> Ry <span class="op">=</span> <span class="op">(</span><span class="dt">double</span> <span class="op">*)</span> <span class="op">&amp;</span>R<span class="op">-&gt;</span>y<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    Ry<span class="op">[</span>i<span class="op">]</span> <span class="op">+=</span> ev<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> mod <span class="op">=</span> sqrt<span class="op">(</span>sq<span class="op">(</span>Rx<span class="op">[</span>i<span class="op">])</span> <span class="op">+</span> sq<span class="op">(</span>Ry<span class="op">[</span>i<span class="op">]));</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    Rx<span class="op">[</span>i<span class="op">]</span> <span class="op">/=</span> mod<span class="op">;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    Ry<span class="op">[</span>i<span class="op">]</span> <span class="op">/=</span> mod<span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></div>
                <p>The stress tensor depends on previous instants and
                has to be integrated in time. In the log-conformation
                scheme the advection of the stress tensor is
                circumvented, instead the conformation tensor, <span
                class="math inline">\(\mathbf{A}\)</span> (or more
                precisely the related variable <span
                class="math inline">\(\Psi\)</span>) is advanced in
                time.</p>
                <p>In what follows we will adopt a scheme similar to
                that of <a href="#hao2007">Hao &amp; Pan (2007)</a>. We
                use a split scheme, solving successively</p>
                <ol type="a">
                <li>the upper convective term: <span
                class="math display">\[
                \partial_t \Psi = 2 \mathbf{B} + (\Omega \cdot \Psi
                -\Psi \cdot \Omega)
                \]</span></li>
                <li>the advection term: <span class="math display">\[
                \partial_t \Psi + \nabla \cdot (\Psi \mathbf{u}) = 0
                \]</span></li>
                <li>the model term (but set in terms of the conformation
                tensor <span class="math inline">\(\mathbf{A}\)</span>).
                In an Oldroyd-B viscoelastic fluid, the model is <span
                class="math display">\[
                \partial_t \mathbf{A} = -\frac{\mathbf{f}_r
                (\mathbf{A})}{\lambda}
                \]</span></li>
                </ol>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>event tracer_advection<span class="op">(</span>i<span class="op">++)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  scalar Psi11 <span class="op">=</span> A11<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  scalar Psi12 <span class="op">=</span> A12<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  scalar Psi22 <span class="op">=</span> A22<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#if AXI</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  scalar Psiqq <span class="op">=</span> AThTh<span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div></div>
                <h3
                id="computation-of-psi-log-mathbfa-and-upper-convective-term">Computation
                of <span class="math inline">\(\Psi = \log
                \mathbf{A}\)</span> and upper convective term</h3>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  foreach<span class="op">()</span> <span class="op">{</span></span></code></pre></div></div>
                <p>We assume that the stress tensor <span
                class="math inline">\(\mathbf{\tau}_p\)</span> depends
                on the conformation tensor <span
                class="math inline">\(\mathbf{A}\)</span> as follows
                <span class="math display">\[
                  \mathbf{\tau}_p = G_p (\mathbf{A}) =
                  G_p (\mathbf{A} - I)
                  \]</span></p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>    pseudo_t A<span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    A<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> A11<span class="op">[];</span> A<span class="op">.</span>y<span class="op">.</span>y <span class="op">=</span> A22<span class="op">[];</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    A<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> A12<span class="op">[];</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#if AXI</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> Aqq <span class="op">=</span> AThTh<span class="op">[];</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    Psiqq<span class="op">[]</span> <span class="op">=</span> log <span class="op">(</span>Aqq<span class="op">);</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div></div>
                <p>The conformation tensor is diagonalized through the
                eigenvector tensor <span
                class="math inline">\(\mathbf{R}\)</span> and the
                eigenvalues diagonal tensor, <span
                class="math inline">\(\Lambda\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    pseudo_v Lambda<span class="op">;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    init_pseudo_v<span class="op">(&amp;</span>Lambda<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    pseudo_t R<span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    init_pseudo_t<span class="op">(&amp;</span>R<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    diagonalization_2D <span class="op">(&amp;</span>Lambda<span class="op">,</span> <span class="op">&amp;</span>R<span class="op">,</span> <span class="op">&amp;</span>A<span class="op">);</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/*</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Check for negative eigenvalues -- this should never happen. If it does, print the location and value of the offending eigenvalue.</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Please report this bug by opening an issue on the GitHub repository.</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">    */</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>Lambda<span class="op">.</span>x <span class="op">&lt;=</span> <span class="fl">0.</span> <span class="op">||</span> Lambda<span class="op">.</span>y <span class="op">&lt;=</span> <span class="fl">0.</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>      fprintf<span class="op">(</span>ferr<span class="op">,</span> <span class="st">&quot;Negative eigenvalue detected: Lambda.x = %g, Lambda.y = %g</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> Lambda<span class="op">.</span>x<span class="op">,</span> Lambda<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      fprintf<span class="op">(</span>ferr<span class="op">,</span> <span class="st">&quot;x = %g, y = %g</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> x<span class="op">,</span> y<span class="op">);</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div></div>
                <p><span class="math inline">\(\Psi = \log
                \mathbf{A}\)</span> is easily obtained after
                diagonalization, <span class="math inline">\(\Psi = R
                \cdot \log(\Lambda) \cdot R^T\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>    Psi12<span class="op">[]</span> <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>log<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    Psi11<span class="op">[]</span> <span class="op">=</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">)</span> <span class="op">+</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    Psi22<span class="op">[]</span> <span class="op">=</span> sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">)</span> <span class="op">+</span> sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">)*</span>log<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">);</span></span></code></pre></div></div>
                <p>We now compute the upper convective term <span
                class="math inline">\(2 \mathbf{B} + (\Omega \cdot \Psi
                -\Psi \cdot \Omega)\)</span>.</p>
                <p>The diagonalization will be applied to the velocity
                gradient <span class="math inline">\((\nabla
                u)^T\)</span> to obtain the antisymmetric tensor <span
                class="math inline">\(\Omega\)</span> and the traceless,
                symmetric tensor, <span
                class="math inline">\(\mathbf{B}\)</span>. If the
                conformation tensor is <span
                class="math inline">\(\mathbf{I}\)</span>, <span
                class="math inline">\(\Omega = 0\)</span> and <span
                class="math inline">\(\mathbf{B}=
                \mathbf{D}\)</span>.</p>
                <p>Otherwise, compute M = R * (nablaU)^T * R^T, where
                nablaU is the velocity gradient tensor. Then,</p>
                <ol type="1">
                <li><p>Calculate omega using the off-diagonal elements
                of M and eigenvalues: omega = (Lambda.y<em>M.x.y +
                Lambda.x</em>M.y.x)/(Lambda.y - Lambda.x) This
                represents the rotation rate in the eigenvector
                basis.</p></li>
                <li><p>Transform omega back to physical space to get OM:
                OM = (R.x.x<em>R.y.y - R.x.y</em>R.y.x)*omega This gives
                us the rotation tensor Omega in the original coordinate
                system.</p></li>
                <li><p>Compute B tensor components using M and R: B is
                related to M and R through:</p>
                <p>In 2D: <span class="math display">\[
                B_{xx} = R_{xx}^2 M_{xx} + R_{xy}^2 M_{yy} \\
                B_{xy} = R_{xx}R_{yx} M_{xx} + R_{xy}R_{yy} M_{yy} \\
                B_{yx} = B_{xy} \\
                B_{yy} = -B_{xx}
                \]</span></p>
                <p>Where:</p>
                <ul>
                <li>R is the eigenvector matrix of the conformation
                tensor</li>
                <li>M is the velocity gradient tensor in the eigenvector
                basis</li>
                <li>The construction ensures B is symmetric and
                traceless</li>
                </ul></li>
                </ol>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>    pseudo_t B<span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    init_pseudo_t<span class="op">(&amp;</span>B<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> OM <span class="op">=</span> <span class="fl">0.</span><span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fabs<span class="op">(</span>Lambda<span class="op">.</span>x <span class="op">-</span> Lambda<span class="op">.</span>y<span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">1e-20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>      B<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/(</span><span class="fl">4.</span><span class="op">*</span>Delta<span class="op">);</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>      foreach_dimension<span class="op">()</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        B<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> <span class="op">(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">])/(</span><span class="fl">2.</span><span class="op">*</span>Delta<span class="op">);</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>      pseudo_t M<span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>      init_pseudo_t<span class="op">(&amp;</span>M<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>      foreach_dimension<span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        M<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> <span class="op">(</span>sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">)*(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[-</span><span class="dv">1</span><span class="op">])</span> <span class="op">+</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        sq<span class="op">(</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">)*(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])</span> <span class="op">+</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]</span> <span class="op">+</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        u<span class="op">.</span>y<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[-</span><span class="dv">1</span><span class="op">]))/(</span><span class="fl">2.</span><span class="op">*</span>Delta<span class="op">);</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        M<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[-</span><span class="dv">1</span><span class="op">])</span> <span class="op">+</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[-</span><span class="dv">1</span><span class="op">])</span> <span class="op">+</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*(</span>u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>x<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])</span> <span class="op">+</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*(</span>u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> u<span class="op">.</span>y<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]))/(</span><span class="fl">2.</span><span class="op">*</span>Delta<span class="op">);</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> omega <span class="op">=</span> <span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">*</span>M<span class="op">.</span>x<span class="op">.</span>y <span class="op">+</span> Lambda<span class="op">.</span>x<span class="op">*</span>M<span class="op">.</span>y<span class="op">.</span>x<span class="op">)/(</span>Lambda<span class="op">.</span>y <span class="op">-</span> Lambda<span class="op">.</span>x<span class="op">);</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>      OM <span class="op">=</span> <span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>y <span class="op">-</span> R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">)*</span>omega<span class="op">;</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>      B<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> M<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x <span class="op">+</span> M<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>      foreach_dimension<span class="op">()</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        B<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> M<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">)+</span>M<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div></div>
                <p>We now advance <span
                class="math inline">\(\Psi\)</span> in time, adding the
                upper convective contribution.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> s <span class="op">=</span> <span class="op">-</span>Psi12<span class="op">[];</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    Psi12<span class="op">[]</span> <span class="op">+=</span> dt <span class="op">*</span> <span class="op">(</span><span class="fl">2.</span> <span class="op">*</span> B<span class="op">.</span>x<span class="op">.</span>y <span class="op">+</span> OM <span class="op">*</span> <span class="op">(</span>Psi22<span class="op">[]</span> <span class="op">-</span> Psi11<span class="op">[]));</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    s <span class="op">*=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    Psi11<span class="op">[]</span> <span class="op">+=</span> dt <span class="op">*</span> <span class="fl">2.</span> <span class="op">*</span> <span class="op">(</span>B<span class="op">.</span>x<span class="op">.</span>x <span class="op">+</span> s <span class="op">*</span> OM<span class="op">);</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    s <span class="op">*=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    Psi22<span class="op">[]</span> <span class="op">+=</span> dt <span class="op">*</span> <span class="fl">2.</span> <span class="op">*</span> <span class="op">(</span>B<span class="op">.</span>y<span class="op">.</span>y <span class="op">+</span> s <span class="op">*</span> OM<span class="op">);</span></span></code></pre></div></div>
                <p>In the axisymmetric case, the governing equation for
                <span class="math inline">\(\Psi_{\theta
                \theta}\)</span> only involves that component, <span
                class="math display">\[
                \Psi_{\theta \theta}|_t - 2 L_{\theta \theta} =
                \frac{\mathbf{f}_r(e^{-\Psi_{\theta \theta}})}{\lambda}
                \]</span> with <span class="math inline">\(L_{\theta
                \theta} = u_y/y\)</span>. Therefore step (a) for <span
                class="math inline">\(\Psi_{\theta \theta}\)</span>
                is</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if AXI</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    Psiqq<span class="op">[]</span> <span class="op">+=</span> dt<span class="op">*</span><span class="fl">2.</span><span class="op">*</span>u<span class="op">.</span>y<span class="op">[]/</span>max<span class="op">(</span>y<span class="op">,</span> <span class="fl">1e-20</span><span class="op">);</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></div>
                <h3 id="advection-of-psi">Advection of <span
                class="math inline">\(\Psi\)</span></h3>
                <p>We proceed with step (b), the advection of the log of
                the conformation tensor <span
                class="math inline">\(\Psi\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if AXI</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  advection <span class="op">({</span>Psi11<span class="op">,</span> Psi12<span class="op">,</span> Psi22<span class="op">,</span> Psiqq<span class="op">},</span> uf<span class="op">,</span> dt<span class="op">);</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  advection <span class="op">({</span>Psi11<span class="op">,</span> Psi12<span class="op">,</span> Psi22<span class="op">},</span> uf<span class="op">,</span> dt<span class="op">);</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div></div>
                <h3 id="convert-back-to-aij">Convert back to Aij</h3>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>  foreach<span class="op">()</span> <span class="op">{</span></span></code></pre></div></div>
                <p>It is time to undo the log-conformation, again by
                diagonalization, to recover the conformation tensor
                <span class="math inline">\(\mathbf{A}\)</span> and to
                perform step (c).</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>    pseudo_t A <span class="op">=</span> <span class="op">{{</span>Psi11<span class="op">[],</span> Psi12<span class="op">[]},</span> <span class="op">{</span>Psi12<span class="op">[],</span> Psi22<span class="op">[]}},</span> R<span class="op">;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    init_pseudo_t<span class="op">(&amp;</span>R<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    pseudo_v Lambda<span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    init_pseudo_v<span class="op">(&amp;</span>Lambda<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    diagonalization_2D <span class="op">(&amp;</span>Lambda<span class="op">,</span> <span class="op">&amp;</span>R<span class="op">,</span> <span class="op">&amp;</span>A<span class="op">);</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    Lambda<span class="op">.</span>x <span class="op">=</span> exp<span class="op">(</span>Lambda<span class="op">.</span>x<span class="op">),</span> Lambda<span class="op">.</span>y <span class="op">=</span> exp<span class="op">(</span>Lambda<span class="op">.</span>y<span class="op">);</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    A<span class="op">.</span>x<span class="op">.</span>y <span class="op">=</span> R<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>R<span class="op">.</span>y<span class="op">.</span>x<span class="op">*</span>Lambda<span class="op">.</span>x <span class="op">+</span> R<span class="op">.</span>y<span class="op">.</span>y<span class="op">*</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">*</span>Lambda<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    foreach_dimension<span class="op">()</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>      A<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>x<span class="op">)*</span>Lambda<span class="op">.</span>x <span class="op">+</span> sq<span class="op">(</span>R<span class="op">.</span>x<span class="op">.</span>y<span class="op">)*</span>Lambda<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#if AXI</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> Aqq <span class="op">=</span> exp<span class="op">(</span>Psiqq<span class="op">[]);</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span></code></pre></div></div>
                <p>We perform now step (c) by integrating <span
                class="math inline">\(\mathbf{A}_t = -\mathbf{f}_r
                (\mathbf{A})/\lambda\)</span> to obtain <span
                class="math inline">\(\mathbf{A}^{n+1}\)</span>. This
                step is analytic, <span class="math display">\[
                \int_{t^n}^{t^{n+1}}\frac{d \mathbf{A}}{\mathbf{I}-
                \mathbf{A}} =
                \frac{\Delta t}{\lambda}
                \]</span></p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#if AXI</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>     <span class="dt">double</span> tauD <span class="op">=</span> sqrt<span class="op">((</span><span class="fl">1.</span><span class="op">/</span><span class="fl">6.</span><span class="op">)*((</span>T11<span class="op">[]</span> <span class="op">-</span> T22<span class="op">[])*(</span>T11<span class="op">[]</span> <span class="op">-</span> T22<span class="op">[])+(</span>T22<span class="op">[]</span> <span class="op">-</span> T_ThTh<span class="op">[])*(</span>T22<span class="op">[]</span> <span class="op">-</span> T_ThTh<span class="op">[])+(</span>T_ThTh<span class="op">[]</span> <span class="op">-</span> T11<span class="op">[])*(</span>T_ThTh<span class="op">[]</span> <span class="op">-</span> T11<span class="op">[]))</span> <span class="op">+</span> T12<span class="op">[]*</span>T12<span class="op">[]);</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#else</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> tauD <span class="op">=</span> sqrt<span class="op">(</span><span class="fl">0.25</span><span class="op">*(</span>T11<span class="op">[]</span> <span class="op">-</span> T22<span class="op">[])*(</span>T11<span class="op">[]</span> <span class="op">-</span> T22<span class="op">[])</span> <span class="op">+</span> T12<span class="op">[]*</span>T12<span class="op">[]);</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> nHB_loc <span class="op">=</span> max<span class="op">(</span>nHB<span class="op">[],</span> <span class="fl">1e-12</span><span class="op">);</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> ohp <span class="op">=</span> max<span class="op">(</span>fabs<span class="op">(</span>Gp<span class="op">[]*</span>lambda<span class="op">[]),</span> saramitoHB_yield_eps<span class="op">);</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> hbArgument <span class="op">=</span> <span class="op">(</span>tauD <span class="op">-</span> tau0<span class="op">[])/</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>pow<span class="op">(</span>ohp<span class="op">,</span> <span class="fl">1.</span> <span class="op">-</span> nHB_loc<span class="op">)*(</span>tauD <span class="op">+</span> saramitoHB_yield_eps<span class="op">));</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> KHB <span class="op">=</span> max<span class="op">(</span><span class="fl">0.</span><span class="op">,</span> pow<span class="op">(</span>max<span class="op">(</span>hbArgument<span class="op">,</span> <span class="fl">0.</span><span class="op">),</span> <span class="fl">1.</span><span class="op">/</span>nHB_loc<span class="op">));</span> <span class="co">// $K_{HB}$</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> intFactor <span class="op">=</span> <span class="op">(</span>lambda<span class="op">[]</span> <span class="op">!=</span> <span class="fl">0.</span> <span class="op">?</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>lambda<span class="op">[]</span> <span class="op">==</span> <span class="fl">1e30</span> <span class="op">?</span> <span class="dv">1</span><span class="op">:</span> exp<span class="op">(-</span>dt<span class="op">*</span>KHB<span class="op">/</span>lambda<span class="op">[])):</span> <span class="fl">0.</span><span class="op">);</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#if AXI</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>      Aqq <span class="op">=</span> <span class="op">(</span><span class="fl">1.</span> <span class="op">-</span> intFactor<span class="op">)</span> <span class="op">+</span> intFactor<span class="op">*</span>exp<span class="op">(</span>Psiqq<span class="op">[]);</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    A<span class="op">.</span>x<span class="op">.</span>y <span class="op">*=</span> intFactor<span class="op">;</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    foreach_dimension<span class="op">()</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>      A<span class="op">.</span>x<span class="op">.</span>x <span class="op">=</span> <span class="op">(</span><span class="fl">1.</span> <span class="op">-</span> intFactor<span class="op">)</span> <span class="op">+</span> A<span class="op">.</span>x<span class="op">.</span>x<span class="op">*</span>intFactor<span class="op">;</span></span></code></pre></div></div>
                <p>Then the Conformation tensor <span
                class="math inline">\(\mathcal{A}_p^{n+1}\)</span> is
                restored from <span
                class="math inline">\(\mathbf{A}^{n+1}\)</span>.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>    A12<span class="op">[]</span> <span class="op">=</span> A<span class="op">.</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    T12<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*</span>A<span class="op">.</span>x<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#if AXI</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>      AThTh<span class="op">[]</span> <span class="op">=</span> Aqq<span class="op">;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>      T_ThTh<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*(</span>Aqq <span class="op">-</span> <span class="fl">1.</span><span class="op">);</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    A11<span class="op">[]</span> <span class="op">=</span> A<span class="op">.</span>x<span class="op">.</span>x<span class="op">;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    T11<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*(</span>A<span class="op">.</span>x<span class="op">.</span>x <span class="op">-</span> <span class="fl">1.</span><span class="op">);</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    A22<span class="op">[]</span> <span class="op">=</span> A<span class="op">.</span>y<span class="op">.</span>y<span class="op">;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    T22<span class="op">[]</span> <span class="op">=</span> Gp<span class="op">[]*(</span>A<span class="op">.</span>y<span class="op">.</span>y <span class="op">-</span> <span class="fl">1.</span><span class="op">);</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></div>
                <h3
                id="divergence-of-the-extra-stress-tensor">Divergence of
                the extra stress tensor</h3>
                <p>The extra stress tensor <span
                class="math inline">\(\mathbf{\tau}_p\)</span> is
                defined at cell centers while the corresponding force
                (acceleration) will be defined at cell faces. Two terms
                contribute to each component of the momentum equation.
                For example the <span
                class="math inline">\(x\)</span>-component in Cartesian
                coordinates has the following terms: <span
                class="math inline">\(\partial_x \mathbf{\tau}_{p_{xx}}
                + \partial_y \mathbf{\tau}_{p_{xy}}\)</span>. The first
                term is easy to compute since it can be calculated
                directly from center values of cells sharing the face.
                The other one is harder. It will be computed from vertex
                values. The vertex values are obtained by averaging
                centered values. Note that as a result of the vertex
                averaging cells <code>[]</code> and <code>[-1,0]</code>
                are not involved in the computation of shear.</p>
                <div class="code-block-container"><div class="code-block-container"><pre
                class="sourceCode c"><code class="sourceCode c"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>event acceleration <span class="op">(</span>i<span class="op">++)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  face vector av <span class="op">=</span> a<span class="op">;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  foreach_face<span class="op">(</span>x<span class="op">){</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fm<span class="op">.</span>x<span class="op">[]</span> <span class="op">&gt;</span> <span class="fl">1e-20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> shearX <span class="op">=</span> <span class="op">(</span>T12<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">+</span> T12<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>      T12<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span> T12<span class="op">[-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/</span><span class="fl">4.</span><span class="op">;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>      av<span class="op">.</span>x<span class="op">[]</span> <span class="op">+=</span> <span class="op">(</span>shearX <span class="op">+</span> cm<span class="op">[]*</span>T11<span class="op">[]</span> <span class="op">-</span> cm<span class="op">[-</span><span class="dv">1</span><span class="op">]*</span>T11<span class="op">[-</span><span class="dv">1</span><span class="op">])*</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>      alpha<span class="op">.</span>x<span class="op">[]/(</span>sq<span class="op">(</span>fm<span class="op">.</span>x<span class="op">[])*</span>Delta<span class="op">);</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  foreach_face<span class="op">(</span>y<span class="op">){</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fm<span class="op">.</span>y<span class="op">[]</span> <span class="op">&gt;</span> <span class="fl">1e-20</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>      <span class="dt">double</span> shearY <span class="op">=</span> <span class="op">(</span>T12<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> T12<span class="op">[</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">]</span> <span class="op">-</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>      T12<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">]</span> <span class="op">-</span> T12<span class="op">[-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>cm<span class="op">[-</span><span class="dv">1</span><span class="op">,-</span><span class="dv">1</span><span class="op">])/</span><span class="fl">4.</span><span class="op">;</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>      av<span class="op">.</span>y<span class="op">[]</span> <span class="op">+=</span> <span class="op">(</span>shearY <span class="op">+</span> cm<span class="op">[]*</span>T22<span class="op">[]</span> <span class="op">-</span> cm<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">]*</span>T22<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])*</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>      alpha<span class="op">.</span>y<span class="op">[]/(</span>sq<span class="op">(</span>fm<span class="op">.</span>y<span class="op">[])*</span>Delta<span class="op">);</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="pp">#if AXI</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>  foreach_face<span class="op">(</span>y<span class="op">)</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>y <span class="op">&gt;</span> <span class="fl">1e-20</span><span class="op">)</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>      av<span class="op">.</span>y<span class="op">[]</span> <span class="op">-=</span> <span class="op">(</span>T_ThTh<span class="op">[]</span> <span class="op">+</span> T_ThTh<span class="op">[</span><span class="dv">0</span><span class="op">,-</span><span class="dv">1</span><span class="op">])*</span>alpha<span class="op">.</span>y<span class="op">[]/</span>sq<span class="op">(</span>y<span class="op">)/</span><span class="fl">2.</span><span class="op">;</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></div>
            </div>
        </main>

        <footer class="site-footer">
            <div class="footer-left">
              <a href="https://basilisk.fr/sandbox/vatsal/" target="_blank" rel="noopener noreferrer">
                <img src="../assets/logos/logoBasilisk_TransparentBackground.png" alt="Basilisk C" class="footer-logo">
              </a>
              <a href="https://pof.tnw.utwente.nl/" target="_blank" rel="noopener noreferrer">
                <img src="../assets/logos/LogoPof_transparent_white.png" alt="Physics of Fluids" class="footer-logo pof-logo">
              </a>
              <a href="https://www.utwente.nl/" target="_blank" rel="noopener noreferrer">
                <img src="../assets/logos/UT_Logo_2400_Sta_White_EN.png" alt="University of Twente" class="footer-logo">
              </a>
              <a href="https://www.vatsalsanjay.com/" target="_blank" rel="noopener noreferrer">
                <img src="../assets/logos/Logo_Vatsal_v3_OutLine.png" alt="Vatsal Sanjay" class="footer-logo">
              </a>
            </div>
            <div class="footer-center">
              <p class="copyright-text">
                &copy; Copyright<br>
                CoMPhy Lab 2025
              </p>
            </div>
            <div class="footer-right">
              <!-- NOTE: Social media links below are organization-specific. Customize for your organization. -->
              <a href="https://scholar.google.com/citations?user=tHb_qZoAAAAJ&hl=en" target="_blank" rel="noopener noreferrer" aria-label="Google Scholar Profile">
                <i class="ai ai-google-scholar" style="font-size: 2.5em; color: white;"></i>
              </a>
              <a href="https://github.com/comphy-lab" target="_blank" rel="noopener noreferrer" aria-label="GitHub Organization">
                <i class="fa-brands fa-github" style="font-size: 2.5em; color: white;"></i>
              </a>
              <a href="https://www.youtube.com/@CoMPhyLab" target="_blank" rel="noopener noreferrer" aria-label="YouTube Channel">
                <i class="fa-brands fa-youtube" style="font-size: 2.5em; color: white;"></i>
              </a>
              <a href="https://x.com/VatsalSanjay" target="_blank" rel="noopener noreferrer" aria-label="X (Twitter) Profile">
                <i class="fa-brands fa-x-twitter" style="font-size: 2.5em; color: white;"></i>
              </a>
              <a href="https://bsky.app/profile/comphy-lab.org" target="_blank" rel="noopener noreferrer" aria-label="Bluesky Profile">
                <i class="fa-brands fa-bluesky" style="font-size: 2.5em; color: white;"></i>
              </a>
              <a href="https://github.com/comphy-lab/MultiRheoFlow/edit/main/src-local/log-conform-elastoviscoplastic-HB-scalar-2D.h" class="edit-link" aria-label="Edit this page on GitHub">
                <i class="fa-brands fa-github"></i> Edit this page
              </a>
            </div>
          </footer>
    </div>  

    <!-- Command Palette -->
    <div id="simple-command-palette" class="simple-command-palette" style="display: none;">
        <div class="simple-command-palette-backdrop"></div>
        <div class="simple-command-palette-modal">
            <input type="text" id="command-palette-input" placeholder="Type a command..." autocomplete="off">
            <div id="command-palette-results" class="command-palette-results"></div>
            <div class="command-palette-footer">
                <span class="command-palette-footer-item"><kbd>↑</kbd> <kbd>↓</kbd> to navigate</span>
                <span class="command-palette-footer-item"><kbd>enter</kbd> to select</span>
                <span class="command-palette-footer-item"><kbd>esc</kbd> to close</span>
            </div>
        </div>
    </div>


<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    // Add copy button to each code block container
    const codeBlocks = document.querySelectorAll('.code-block-container pre');
    codeBlocks.forEach(function(codeBlock, index) {
        // Create button element
        const button = document.createElement('button');
        button.className = 'copy-button';
        button.textContent = 'Copy';
        button.setAttribute('aria-label', 'Copy code to clipboard');
        button.setAttribute('data-copy-state', 'copy');
        
        // Get the code block container (parent of the pre)
        const container = codeBlock.parentNode;
        
        // Add the button to the container
        container.appendChild(button);
        
        // Set up click event
        button.addEventListener('click', async function() {
            const codeText = codeBlock.textContent;
            
            try {
                // Try to use the modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(codeText);
                    updateButtonState(button, 'success');
                } else {
                    // Fall back to the deprecated execCommand method
                    const textarea = document.createElement('textarea');
                    textarea.value = codeText;
                    textarea.style.position = 'fixed';  // Prevent scrolling to the bottom
                    document.body.appendChild(textarea);
                    textarea.select();
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    
                    if (successful) {
                        updateButtonState(button, 'success');
                    } else {
                        updateButtonState(button, 'error');
                    }
                }
            } catch (err) {
                console.error('Copy failed:', err);
                updateButtonState(button, 'error');
            }
        });
    });
    
    // Function to update button state
    function updateButtonState(button, state) {
        if (state === 'success') {
            button.textContent = 'Copied!';
            button.classList.add('copied');
        } else if (state === 'error') {
            button.textContent = 'Error!';
            button.classList.add('error');
        }
        
        // Reset button state after 2 seconds
        setTimeout(function() {
            button.textContent = 'Copy';
            button.classList.remove('copied', 'error');
        }, 2000);
    }
});
</script>
        </body>
</html>
